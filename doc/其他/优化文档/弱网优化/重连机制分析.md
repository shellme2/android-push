# Im推送保活重连机制

## 一、现阶段机制分析

### 1、服务重启
+ 网络变化广播
	+ 有网：turnOn，重启im服务；
	+ 无网：turnOff,关闭im服务；
+ 开机广播
	+ turnOn，重启im服务；
+ ConnectionService异常
	+ OnDesrory:turnOn，重启im服务；
	+ onStartCommond：initPush;

+ 说明：turnOn，会调用iniPush，相当于重连初始化，需要进行一次Socket连接，在此之前会cancelconnect任务,并置connectPeriodTag=0;

### 2、Socket重连

+ Socket连接失败尝试重连
	+ Socket连接成功时：cancelconnect任务,并置connectPeriodTag=0;
	+ 上层添加TCP连接时:cancelconnect任务,并置connectPeriodTag=0;
	+ Socket连接失败时：
		+ 如果是DNS错误，且切换Host解析新的Host成功，则：置connectPeriodTag=0，并RetryAlarm重连Socket;
		+ 如果不是DNS错误，或者是DNS错误，但是解析新的Host失败，切换下Host,直接RetryAlarm重连Socket;
		+ RetryAlarm时根据connectPeriodTag为参数计算重连间隔时间，然后connectPeriodTag+1递增（最大递增到20）；
+ Socket连接中断尝试重连
	+ 距离上次连接<1000ms
		+ 根据reconnectPeriodTag为参数计算重连间隔时间，然后reconnectPeriodTag+1递增（最大递增到20）
	+ 距离上次连接>1000ms
		+ 置reconnectPeriodTag=0，添加即时connectTask到队列中，启动重连；

+ 心跳20秒响应超时尝试重连
	+ cancelconnect任务，并置connectPeriodTag=0;


## 现阶段弱网情况缺陷分析

### 情景一：连接成功中断导致的socket重连
+ 现象描述：弱网情况下频繁连接成功后立马断开（但是时间间隔>1000ms)；
+ 相似现象：
	+ 手动关闭或者打开网络时，如果此刻正在接收数据，就会出现这种情况；
	+ 手机离开wifi范围，或者进入数据信号中断区域网络断开，如果此刻正在接收数据，就会出现这种情况；
+ 缺陷分析：间隔时间大于1000ms的情况下，现有的机制会立即触发重连，可能导致频繁重连且间隔时间较短（但>1000ms)的情况；
+ 优化建议：适当延长1000ms；


### 情景二：连接失败导致的socket重连（重点改善）
+ 现象描述：
	+ 弱网连接失败，导致再次重连；
	+ 无效网络由于Android的API无法判断，连不上但是会一直触发重连；
+ 相似现象：正常网络也有可能存在连接失败的问题，比如DNS错误；
+ 优化建议：
	+ 1、对于DNS错误导致的重连，不能标记为弱网，应该尽量快速的进行再次重连；
	+ 2、对于网络问题导致连接失败的，前面的可以按照现在的情况进行递增延时重连，但是如果到达最大延迟时间后还是持续重连，可以考虑间歇执行重连任务；

### 情景三：服务重启导致的socket重连
+ 现象描述：
	+ 1、手机欠费（移动卡）的情况下，网络变化广播一直频繁发出，导致服务重启，并进行Socket连接工作；
	+ 2、待机情况下，系统会强制杀死应用，导致服务重连，然后会进行Socket连接；

+ 相似现象：
	+ 1、正常的切换网络，或者关闭打开网络；
	+ 2、机器开机；

+ 优化建议：
	+ 这个在手机欠费（移动卡）的情况下，会不断的重启服务。此处拦截可以在监听网络广播处进行，但是如何才能最大化的用好网络广播，一旦拦截就会影响到正常情况，网络随时在变化。

### 情景四：心跳20s超时响应触发的socket重连
+ 现象描述：
	+ 发送心跳包时会添加一个20s延迟重连任务，如果这20s内没有被cancle掉就会触发，此刻被认为此次心跳失败；
+ 相似现象：
	+ 在正常网络情况下，由于心跳的时间间隔会超过5分钟的安全时间间隔，这种重连应该视为正常现象的重连；

+ 优化建议：
	+ 此时别认为心跳失败，会触发一次重连，并只有Soceket连接成功的话才会触发心跳，所以不会引起频繁重连的问题，视为正常现象，不做处理。

### 情景五：心跳发送请求失败触发的socket重连
+ 现象描述：
	+ 提交一个心跳发送任务，刚好此时网络中断，发送心跳包请求失败，此刻应该是socket已经断开连接，所以立即触发TCP连接，并进行socket重连任务；

+ 正常现象：
	+ 人为关闭网络时正好发起了心跳请求。

+ 优化建议：
	+ 此时别认为心跳失败，会触发一次重连，并只有Soceket连接成功的话才会触发心跳，所以不会引起频繁重连的问题，视为正常现象，不做处理。

### 情景六：IO流读数据Data解析发生异常触发的socket从重连
+ 现象描述：
	+ 网络中断时，连接出现异常，读取数据可能出现读取不全的情况，导致TLV协议解析失败，说明传输的数据有误，连接有问题，重启TCP连接；

+ 相似现象：
	+ 手动关闭或者打开网络时，如果此刻正在接收数据，就会出现这种情况；
	+ 手机离开wifi范围，或者进入数据信号中断区域网络断开，如果此刻正在接收数据，就会出现这种情况；

+ 优化建议：
	+ 这个在read时有一些判断处理，出现的频率较低，应属于正常的重连，不做处理。

### 小结

+ 上层触发的TCP连接，主要集中在网络频繁变化触发的，尤其是手机欠费的情况，可以对这种情况进行单独的处理；
+ 下层Socket连接失败有循环重连处理，可以考虑对于一直重连但是连接不上的网络进行特殊处理，比如延迟重连时间间隔，减少重连次数等方法。

## 解决方案：

###方法探讨
+ 方法一：**增大1000ms这个时间间隔标准；**
	+ 缺点：但是正常好网也有存在突然掉线断开的情况，比如我们的心跳机制已经超越5分钟，存在掉线的高风险，这样修改的话时效性降低；
	+ 建议：推送的时效性要求相对聊天等要求并不是说特别的高，适当延迟在可以接受的范围之类；
	+ 想法：可以将时效性要求公开到上层应用，根据上层应用的要求来动态设定此值；
+ 方法二：**标记频繁连接的弱网，递增延时重连；**
	+ 难点：弱网标记困难；
	+ 想法：可以记录Socket连接的次数，过于频繁的时候进行ping操作，如果多次ping失败，则理解为弱网。
+ 方法三：**增加递增算法中最长时间间隔限制，目前为20分钟；**
	+ 缺点：时效性降低，假设网络突然变好的情况下，等待连接的时间可能过长；
	+ 想法：对于被标识的弱网，增加最长时间；
+ 方法四：**标记频繁连接的弱网，间歇惰性处理重连任务；**
	+ 想法：对于被标识的弱网，我们间接性的执行重连任务，比如3次只执行2次，重连任务的频率相同的情况下，减少执行的次数（随着时间的延续减少概率），在网络突然变好的情况下也存在一定的概率在时间间隔较短的时间内执行再次重连任务；
+ 方法五：**当连接的网络切换后重置所有数据；**
	+ 解决问题：当用户发现连不上网络的时候，切换到别的网络环境，这个时候原先的弱网标记数据应该清除。

### 递增延迟连接
+ 延续现有算法，每次增加1改为增加2；

### 惰性间歇连接

+ 算法解释：假设每次间隔时间为20分钟，两次为一个循环。那么第0,20, 40,60， 80,100， 120,140 的情况下第40，120 分钟即第二个循环和第4个循环有一次任务不执行，间歇的概率可以持续优化；

### 弱网标识方案

+ 边界条件：
	+ 执行最大递增延迟间隔（20分钟）连接连续5次；
	+ 第四次和第五次ping网络连续失败；

+ 弱网锁定：
	+ 符合上述边界条件则修改当前网络环境为弱网环境，修改网络环境标志位；

+ 弱网解锁：
	+ 当任何一次socket连接成功或者心跳响应成功都解锁弱网，修改网络环境标志位；

### 整体方案

+ 探测阶段：采用递增算法，并记录触发重连的时间频率，识别标记是否为弱网网络；
+ 弱网优化：识别为弱网后执行间歇惰性算法，按照一定的规律不执行重连任务；
+ 优化重置：网络切换等特定情况，重置弱网标记。

### 流程图

![](http://172.28.2.93/bfc/BfcPush/blob/develop-zjf/doc/%E5%85%B6%E4%BB%96/%E4%BC%98%E5%8C%96%E6%96%87%E6%A1%A3/%E5%BC%B1%E7%BD%91%E4%BC%98%E5%8C%96/%E4%B8%AD%E9%97%B4%E4%BB%B6IM%E6%8E%A8%E9%80%81Socket%E9%87%8D%E8%BF%9E%E6%9C%BA%E5%88%B6%E7%AE%80%E7%89%88.png)


![](http://172.28.2.93/bfc/BfcPush/blob/develop-zjf/doc/%E5%85%B6%E4%BB%96/%E4%BC%98%E5%8C%96%E6%96%87%E6%A1%A3/%E5%BC%B1%E7%BD%91%E4%BC%98%E5%8C%96/%E4%B8%AD%E9%97%B4%E4%BB%B6IM%E6%8E%A8%E9%80%81%EF%BC%88Socket%E9%87%8D%E8%BF%9E%E6%9C%BA%E5%88%B6%E7%AE%80%E7%89%88%EF%BC%89.png)
